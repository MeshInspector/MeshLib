name: Update Windows distribution version

on:
  workflow_call:
    inputs:
      vs19_vcpkg_version:
        required: true
        type: string
      app_version:
        required: true
        type: string

jobs:
  update-win-version:
    timeout-minutes: 60
    runs-on: [self-hosted, windows, x64, vs-2019, vcpkg-2024.10.21, meshinspector]
    env:
      vs19_vcpkg_version: ${{ inputs.vs19_vcpkg_version }}
    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          submodules: true

      - name: Checkout Vcpkg ${{env.vs19_vcpkg_version}}
        working-directory: C:\vcpkg
        run: |
          git fetch
          git checkout ${{env.vs19_vcpkg_version}}

      - name: Restore Vcpkg Cache
        uses: actions/cache@v4
        id: vcpkg-cache
        with:
          key: vcpkg-cache-${{env.vs19_vcpkg_version}}
          path: |
            C:\vcpkg\*

      - name: Update vcpkg packages
        # NOTE: This step (thirdparty/install.bat) is the only one keeping us from using github runner for this job
        run: |
          .\thirdparty\install.bat

      - name: Download Windows Binaries Archive
        uses: actions/download-artifact@v5
        with:
          pattern: WindowsArchive*
          merge-multiple: true

      - name: Extract Windows Binaries
        run: |
          tar -xvzf MREDist_Release.zip
          tar -xvzf MREDist_Debug.zip
          tar -xvzf MeshLibC2Headers.zip

      - name: Make Install Folder
        run: py -3.10 scripts\make_install_folder.py ${{ inputs.app_version }}

      - name: Add msbuild to PATH
        uses: microsoft/setup-msbuild@6fb02220983dee41ce7ae257b6f4d8f9bf5ed4ce # v2

      - name: Archive Distribution
        run: py -3.10 scripts\zip_distribution.py install example_plugin MeshLibDist.zip

      - name: Test Example Plugin # call it after archive not to pack build results
        run: |
          msbuild -m example_plugin\example_plugin.sln -p:Configuration=Debug
          msbuild -m example_plugin\example_plugin.sln -p:Configuration=Release

      - name: Upload Windows Distribution
        uses: actions/upload-artifact@v4
        with:
          name: DistributivesWin
          path: MeshLibDist.zip
          retention-days: 1