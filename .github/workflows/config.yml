name: Configuration

on:
  workflow_call:
    outputs:
      # manually defined values
      vcpkg_version:
        description: "vcpkg version"
        value: "2024.10.21" # VCPKG-AUTO-UPDATE - refer 'vcpkg-auto-update.yml' for more info
      # automatically computed or tag-based values
      app_version:
        description: "Version without namespace: v1.2.3.4"
        value: ${{ jobs.prepare-config.outputs.app_version }}
      full_config_build:
        description:
        value: ${{ github.event_name == 'schedule' || jobs.prepare-config.outputs.tag-full-ci == 'true' }}
      docker_image_tag:
        description:
        value: ${{ jobs.prepare-config.outputs.docker-image-tag }}
      internal_build:
        description:
        value: ${{ github.event_name != 'pull_request' || github.event.pull_request.head.repo.full_name == github.repository }}
      need_linux_image_rebuild:
        description:
        value: ${{ jobs.prepare-config.outputs.linux-changes == 'true' && github.event_name != 'schedule' && jobs.prepare-config.outputs.tag-skip-image-rebuild != 'true' }}
      need_windows_vcpkg_rebuild:
        description:
        value: ${{ jobs.prepare-config.outputs.windows-changes == 'true' || jobs.prepare-config.outputs.tag-bump-vcpkg == 'true' }}
      release_tag:
        description: "Version with namespace (if it exists): v1.2.3.4-namespace"
        value: ${{ jobs.prepare-config.outputs.release_tag }}
      ubuntu_x64_config_matrix:
        description: "Config matrix for Ubuntu x64 builds"
        value: ${{ jobs.prepare-config.outputs.ubuntu_x64_config_matrix }}
      update_doc:
        description:
        value: ${{ jobs.prepare-config.outputs.tag-update-doc == 'true' || jobs.prepare-config.outputs.tag-update-doc-only == 'true' }}
      upload_artifacts:
        description:
        value: ${{ github.event_name == 'push' || jobs.prepare-config.outputs.tag-full-ci == 'true' }}
      upload_test_artifacts:
        description:
        value: ${{ jobs.prepare-config.outputs.tag-upload-test-artifacts == 'true' }}
      test_pip_build:
        description:
        value: ${{ jobs.prepare-config.outputs.tag-test-pip-build == 'true' }}
      # flags for disabling builds for different systems
      build_enable_ubuntu_arm64:
        description:
        value: ${{ !( jobs.prepare-config.outputs.tag-disable-ubuntu-arm64 == 'true' ) }}
      build_enable_ubuntu_x64:
        description:
        value: ${{ !( jobs.prepare-config.outputs.tag-update-doc-only == 'true' || jobs.prepare-config.outputs.tag-disable-ubuntu-x64 == 'true' ) }}
      build_enable_fedora:
        description:
        value: ${{ !( jobs.prepare-config.outputs.tag-update-doc-only == 'true' || jobs.prepare-config.outputs.tag-disable-fedora == 'true' ) }}
      build_enable_windows:
        description:
        value: ${{ !( jobs.prepare-config.outputs.tag-update-doc-only == 'true' || jobs.prepare-config.outputs.tag-disable-windows == 'true' ) }}
      build_enable_macos:
        description:
        value: ${{ !( jobs.prepare-config.outputs.tag-update-doc-only == 'true' || jobs.prepare-config.outputs.tag-disable-macos == 'true' ) }}
      build_enable_emscripten:
        description:
        value: ${{ !( jobs.prepare-config.outputs.tag-update-doc-only == 'true' || jobs.prepare-config.outputs.tag-disable-emscripten == 'true' ) }}

jobs:
  prepare-config:
    outputs:
      app_version:              ${{ steps.version-tag.outputs.app_version }}
      docker-image-tag:         ${{ steps.select-docker-image-tag.outputs.image_tag }}
      release_tag:              ${{ steps.version-tag.outputs.release_tag }}
      linux-changes:            ${{ steps.linux-changes.outputs.src }}
      ubuntu_x64_config_matrix: ${{ steps.set-ubuntu-x64-matrix.outputs.matrix }}
      windows-changes:          ${{ steps.windows-changes.outputs.src }}
      # please list the required tags here
      tag-bump-vcpkg:            ${{ contains( github.event.pull_request.labels.*.name, 'bump-vcpkg' ) }}
      tag-full-ci:               ${{ contains( github.event.pull_request.labels.*.name, 'full-ci' ) }}
      tag-skip-image-rebuild:    ${{ contains( github.event.pull_request.labels.*.name, 'skip-image-rebuild' ) }}
      tag-update-doc:            ${{ contains( github.event.pull_request.labels.*.name, 'update-doc' ) }}
      tag-update-doc-only:       ${{ contains( github.event.pull_request.labels.*.name, 'update-doc-only' ) }}
      tag-upload-test-artifacts: ${{ contains( github.event.pull_request.labels.*.name, 'upload-test-artifacts' ) }}
      tag-test-pip-build:        ${{ contains( github.event.pull_request.labels.*.name, 'test-pip-build' ) }}
      # tags for disabling builds for different systems
      tag-disable-windows:       ${{ contains( github.event.pull_request.labels.*.name, 'disable-build-windows' ) }}
      tag-disable-ubuntu-x64:    ${{ contains( github.event.pull_request.labels.*.name, 'disable-build-ubuntu-x64' ) }}
      tag-disable-ubuntu-arm64:  ${{ contains( github.event.pull_request.labels.*.name, 'disable-build-ubuntu-arm64' ) }}
      tag-disable-fedora:        ${{ contains( github.event.pull_request.labels.*.name, 'disable-build-fedora' ) }}
      tag-disable-macos:         ${{ contains( github.event.pull_request.labels.*.name, 'disable-build-macos' ) }}
      tag-disable-emscripten:    ${{ contains( github.event.pull_request.labels.*.name, 'disable-build-emscripten' ) }}

    runs-on: ubuntu-latest

    env:
      # duplicate output values here since they cannot be accessed from steps
      full_config_build: ${{ github.event_name == 'schedule' || contains( github.event.pull_request.labels.*.name, 'full-ci' ) }}
      upload_artifacts: ${{ github.event_name == 'push' || contains( github.event.pull_request.labels.*.name, 'full-ci' ) }}
      version_namespace: ${{ contains( github.event.pull_request.labels.*.name, 'full-ci' ) && github.event_name != 'push' && 'pr-test' || '' }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: true

      - name: Filter Linux paths
        uses: dorny/paths-filter@v3
        id: linux-changes
        with:
          filters: |
            src:
              - 'docker/ubuntu**'
              - 'docker/fedora**'
              - 'docker/emscripten**'
              - 'requirements/!(windows.txt|macos.txt|python.txt|Brewfile)'
              - 'scripts/build_thirdparty.sh'
              - 'scripts/install_apt_requirements.sh'
              - 'scripts/install_dnf_requirements.sh'
              - 'scripts/mrbind/install_deps_ubuntu.sh'
              - 'thirdparty/!(install.bat|vcpkg/**)'

      - name: Filter Windows paths
        uses: dorny/paths-filter@v3
        id: windows-changes
        with:
          filters: |
            src:
              - 'requirements/windows.txt'
              - 'thirdparty/vcpkg/**'
              - 'thirdparty/install.bat'

      - name: Get current branch name
        if: ${{ steps.linux-changes.outputs.src == 'true' }}
        id: branch-name
        uses: tj-actions/branch-names@v8.0.1

      # if nothing to rebuild: "latest"
      # else: $branch-name | sed -r 's/[^a-zA-Z0-9._-]+/-/
      # example: fix/mesh -> fix-mesh
      - name: Select Docker image tag
        id: select-docker-image-tag
        run: |
          if [[ ${{ steps.linux-changes.outputs.src }} == 'true' ]] && [[ ${{ github.event_name }} != 'push' && ${{ github.event_name }} != 'schedule' ]]; then
            IMAGE_TAG=$(echo "${{ steps.branch-name.outputs.current_branch }}" | sed -r 's/[^a-zA-Z0-9._-]+/-/g')
          else
            IMAGE_TAG="latest"
          fi
          echo "image_tag=${IMAGE_TAG}" >> $GITHUB_OUTPUT

      - name: Checkout full history
        if: ${{ env.upload_artifacts == 'true' }}
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Versioning
        if: ${{ env.upload_artifacts == 'true' }}
        uses: paulhatch/semantic-version@v5.4.0
        id: version
        with:
          tag_prefix: "v"
          version_format: "v${major}.${minor}.${patch}.${increment}"
          bump_each_commit: false
          search_commit_body: true
          namespace: ${{ env.version_namespace }}

      - name: Set version tag
        id: version-tag
        run: |
          version=${{ steps.version.outputs.version }}
          echo "release_tag=${version}" >> $GITHUB_OUTPUT
          echo "app_version=${version%%-*}" >> $GITHUB_OUTPUT

      - name: Set matrix for ubuntu-arm64 builds
        id: set-ubuntu-x64-matrix
        run: |
          if [[ "${{ env.full_config_build }}" == "true" ]]; then
            echo "matrix=$(jq -c . < .github/workflows/matrix/ubuntu-x64-full-config.json)" >> $GITHUB_OUTPUT
          else
            echo "matrix=$(jq -c . < .github/workflows/matrix/ubuntu-x64-minimal-config.json)" >> $GITHUB_OUTPUT
          fi

  linux-image-build-upload:
    needs: [prepare-config]
    if: ${{ needs.prepare-config.outputs.linux-changes == 'true' && !contains( github.event.pull_request.labels.*.name, 'skip-image-rebuild' ) }}
    timeout-minutes: 75
    strategy:
      fail-fast: false
      matrix:
        distro: [ ubuntu20, ubuntu22, ubuntu24, fedora39, emscripten ]
        arch: [ x64, arm64 ]
        exclude:
          - distro: fedora39
            arch: arm64
          - distro: emscripten
            arch: x64
        include:
          - arch: x64
            image-suffix: ''
            os: ubuntu-latest
          - arch: arm64
            image-suffix: '-arm64'
            os: [ self-hosted, linux-arm64 ]
    runs-on: ${{ matrix.os }}
    env:
      dockerfile: ${{ matrix.distro }}Dockerfile
      image: meshlib/meshlib-${{ matrix.distro }}${{ matrix.image-suffix }}:${{ needs.prepare-config.outputs.docker-image-tag }}
    steps:
      - name: Remove unused Docker data
        run: docker system prune --force --all --volumes

      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: true

      - name: Login to DockerHub
        uses: docker/login-action@v3
        with:
          username: meshlib
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build Linux image
        run: docker build -f ./docker/${{ env.dockerfile }} -t ${{ env.image }} . --progress=plain

      - name: Push Linux image
        run: docker push ${{ env.image }}

      - name: Remove unused Docker data
        run: docker system prune --force --all --volumes

  windows-vcpkg-build-upload:
    needs: [prepare-config]
    if: ${{ needs.prepare-config.outputs.windows-changes == 'true' && !contains( github.event.pull_request.labels.*.name, 'skip-image-rebuild' )}}
    timeout-minutes: 240
    runs-on: windows-2022
    steps:
      - name: Setup vcpkg
        working-directory: C:\vcpkg
        run: |
          git fetch
          git checkout ${{ inputs.vcpkg_version }}
          bootstrap-vcpkg.bat
          vcpkg.exe integrate install

      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: true

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1

      - name: Build and cache vcpkg
        run: .\thirdparty\install.bat --write-s3

