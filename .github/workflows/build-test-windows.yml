name: Build and test Windows

on:
  workflow_call:
    inputs:
      image_tag:
        required: true
        type: string
      version:
        required: true
        type: string
      UPLOAD_ARTIFACTS:
        required: true
        type: boolean

jobs:
  windows-build-test:
    timeout-minutes: 60
    runs-on: windows-2019
    strategy:
      matrix:
        config: [Debug, Release]
    steps:
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1

      - name: Install dependenices
        working-directory: C:\vcpkg
        run: |
          dotnet nuget add source "https://meshlib-259351611210.d.codeartifact.us-east-1.amazonaws.com/nuget/meshlib-vcpkg/v3/index.json" -n "meshlib/meshlib-vcpkg"
          nuget install vcpkg-export-20230329-153927 -Source "meshlib/meshlib-vcpkg"
          Xcopy "C:\Program Files\PackageManagement\NuGet\Packages\vcpkg-export-20230329-153927.1.0.0" C:\vcpkg /E/H/C/I
          C:\vcpkg\vcpkg.exe integrate install
          choco install cuda --version=11.4.2.47141 --confirm

      - name: Checkout
        uses: actions/checkout@v3
        with:
          submodules: recursive

      - name: Setup python
        run: |
          py -3.10 -m ensurepip --upgrade
          py -3.10 -m pip install --upgrade pip
          py -3.10 -m pip install -r .\requirements\python.txt

      - name: Build
        run: |
          MSBuild.exe source\MeshLib.sln -p:Configuration=${{ matrix.config }}

      - name: Run Test
        working-directory: source\x64\${{ matrix.config }}
        run: .\MeshViewer.exe -tryHidden -noEventLoop

      - name: Unit Tests
        run: py -3 scripts\run_unit_test_script.py ${{ matrix.config }}

      - name: Python Tests
        working-directory: source\x64\${{ matrix.config }}
        run: py -3 ..\..\..\scripts\run_python_test_script.py

      - name: Archive files # https://github.com/actions/download-artifact#maintaining-file-permissions-and-case-sensitive-files
        if: ${{ inputs.UPLOAD_ARTIFACTS }}
        run: tar -a -c -f MREDist_${{ matrix.config }}.zip ./source/x64/${{matrix.config}}

      - name: Upload Windows Binaries Archive
        if: ${{ inputs.UPLOAD_ARTIFACTS }}
        uses: actions/upload-artifact@v3
        with:
          name: WindowsArchive
          path: MREDist_${{ matrix.config }}.zip
          retention-days: 1
